<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dissyboard Server Liste</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body { 
            background: linear-gradient(to bottom, #202225, #2f3136);
            color: #dcddde; 
            background-attachment: fixed;
        }
        .navbar { background-color: #2f3136; }
        .navbar-brand { font-weight: bold; }
        #user-avatar { width: 32px; height: 32px; } /* Kleinere, feste Größe für das Avatar */
        .hero { 
            padding: 5rem 0; 
            text-align: center; 
            background: rgba(47, 49, 54, 0.5);
        }
        .hero h1 { text-shadow: 0px 2px 15px rgba(88, 101, 242, 0.5); }
        .server-card {
            background-color: #2f3136;
            border: 1px solid rgba(88, 101, 242, 0.2);
            transition: transform 0.2s ease-in-out;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        }
        .server-card:hover { transform: translateY(-8px); border-color: rgba(88, 101, 242, 0.7); }
        .server-card .card-title { color: #ffffff; }
        .server-card .btn-primary { 
            background: linear-gradient(45deg, #5865F2, #7289da); 
            border: none;
        }
        .server-card .card-img-top { height: 180px; object-fit: cover; background-color: #202225; border-bottom: 1px solid rgba(88, 101, 242, 0.2); }
        .footer { background-color: #2f3136; padding: 2rem 0; margin-top: 4rem; text-align: center; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="/"><i class="bi bi-discord"></i> Dissyboard</a>
        <div class="ms-auto">
            <!-- Login Button -->
            <div id="login-section" style="display: none;">
                <a href="/auth/discord" class="btn btn-primary login-button">Mit Discord einloggen</a>
            </div>
            <!-- User Profile Dropdown -->
            <div id="user-info" class="dropdown" style="display: none;">
                <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                    <img id="user-avatar" src="" alt="Avatar" class="rounded-circle me-2">
                    <strong id="user-name"></strong>
                </a>
                <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                    <li><a class="dropdown-item" href="/add-server"><i class="bi bi-plus-circle me-2"></i>Server hinzufügen</a></li>
                    <li><a id="admin-link" class="dropdown-item" href="/admin" style="display: none;"><i class="bi bi-shield-lock me-2"></i>Admin Panel</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="/logout"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                </ul>
            </div>
        </div>
    </div>
</nav>

<main>
    <div class="hero">
        <div class="container">
            <h1 class="display-4 fw-bold text-white">Finde deine Community</h1>
            <p class="lead text-white-50">Durchstöbere die besten deutschen Discord-Server oder trage deinen eigenen ein.</p>
        </div>
    </div>

    <div class="container mt-5">
        <h2 class="text-white mb-4">Top Server</h2>
        <div id="server-list" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            <!-- Server-Karten werden hier per JS eingefügt -->
        </div>
    </div>
</main>

<footer class="footer">
    <div class="container">
        <span class="text-white-50">© 2024 Dissyboard</span>
    </div>
</footer>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const userInfo = document.getElementById('user-info');
        const loginSection = document.getElementById('login-section');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const adminLink = document.getElementById('admin-link');

        // Benutzerdaten abrufen
        try {
            const response = await fetch('/api/user');
            if (response.ok) {
                const user = await response.json();
                userInfo.style.display = 'block';
                loginSection.style.display = 'none';
                userName.textContent = user.username;
                const avatarUrl = `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`;
                userAvatar.src = avatarUrl;

                if (user.id === '1435148566850048114') {
                    adminLink.style.display = 'block';
                }
            } else {
                // NEU: Wenn der Benutzer nicht angemeldet ist, zeige den Login-Button an
                userInfo.style.display = 'none';
                loginSection.style.display = 'block';
            }
        } catch (error) {
            // NEU: Fallback, falls ein Fehler auftritt
            console.error('Fehler beim Abrufen des Benutzerstatus:', error);
            userInfo.style.display = 'none';
            loginSection.style.display = 'block';
        }

        // Serverliste abrufen
        try {
            const serverResponse = await fetch('/api/servers');
            const servers = await serverResponse.json();
            const serverListContainer = document.getElementById('server-list');
            serverListContainer.innerHTML = '';

            if (servers && servers.length > 0) {
                servers.forEach(server => {
                    const imageUrl = server.imageUrl ? server.imageUrl : 'https://via.placeholder.com/400x225/2f3136/5865F2?text=Kein+Bild';
                    serverListContainer.innerHTML += `
                        <div class="col">
                            <div class="card server-card h-100">
                                <img src="${imageUrl}" class="card-img-top" alt="Server Bild">
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">${server.serverName}</h5>
                                    <p class="card-text text-white-50 flex-grow-1">${server.description}</p>
                                    <a href="${server.inviteLink}" target="_blank" class="btn btn-primary mt-auto">Beitreten</a>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                serverListContainer.innerHTML = '<p class="text-white-50">Aktuell sind keine Server gelistet. Sei der Erste und füge einen hinzu!</p>';
            }
        } catch (error) {
            console.error('Fehler beim Laden der Serverliste:', error);
            document.getElementById('server-list').innerHTML = '<p class="text-danger">Fehler beim Laden der Server.</p>';
        }
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
